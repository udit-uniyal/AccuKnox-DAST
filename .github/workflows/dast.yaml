name: OWASP ZAP Scanning Workflow

on:
  push:
    branches: [ main ]  # Adjust if you use a different branch as your default
  pull_request:
    branches: [ main ]  # Adjust if you use a different branch for PRs

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set full permissions
        run: sudo chmod -R 777 .
        
      - name: Set up Docker Environment
        run: |
          sudo chmod -R 777 ${{ github.workspace }}
          echo "TARGET_URL=https://risasdental.com/" >> $GITHUB_ENV
          

      - name: OWASP ZAP Scan
        run: |
          docker run --rm -v ${{ github.workspace }}:/zap/wrk/:rw -t zaproxy/zap-stable zap-baseline.py \
            -t http://testphp.vulnweb.com/ \
            -r scanreport.html \
            -x scanreport.xml \
            -J scanreport.json \
            -I

      - name: List reports
        run: |
          echo "Listing generated reports..."
          ls -l ${GITHUB_WORKSPACE}

      - name: Upload ZAP Scan Report
        run: |
            cd ${GITHUB_WORKSPACE}
            curl --location --request POST "https://cspm.stage.accuknox.com/api/v1/artifact/?tenant_id=5088&data_type=ZAP&save_to_s3=false" \
              --header "Tenant-Id: 5088" \
              --header "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxODg0OTM3OTY5LCJqdGkiOiI0MDc3YWI5MTdlNTQ0NGEwYTFmNmExZTYzYWM5ZGVjYyIsImlzcyI6ImNzcG0uc3RhZ2UuYWNjdWtub3guY29tIn0.RUAFGIfS8NhZ83SZ-Rkw07-BIdXWpRjAbqTLzJvYz8Z-cjxJ4uUvH-h3-xGMpQ26a_tA8h1AvzM60L2pS338QA0CRVZrH0WTtNNagb2eNJdnYOH6YW7sdDAWE78SroRS8nKZFGyvGAILz7iDyNcf_rXybAhTCN-zjIjv1Hy73dECO0KCgx9j6_hB7Eyhqdm8_RmJZStL9sSyyywNLyUDMMsP35ah42ARdiF2OB3_fQIwrIRS9ICoAtCqRW6sTh4ctzfdv4PPJFsOeuxzl3pEpVPnwj7yR9QZojD5LjiZujK6k8WhVKZRQMPtCJ9HKm_igIDC4qGh0Yqi9qV35MEe8g" \
              --form "file=@\"scanreport.json\""
